This directory includes code to download and process data from the ABCD Community Collection. To reproduce processing:

# Non-ABCC Downloads

These are downloaded from other sources.

* *ABCC_Collection_Manifest/* contains the manifest downloaded from the NDA repository (not included in the repo: see [nda-abcd-s3-downloader](https://github.com/ABCD-STUDY/nda-abcd-s3-downloader) ).

The glasser atlas, along with code used to generate inter-parcel distances, is stored in *GlasserDistances/*

# Download ABCC Data

## Making the file list

* *getnsubjects.sh* fetches a number of subject IDs defined by the first argument
* *missingness_subsets.txt* contains a list of file types we are targetting for download (for a full list of available file types see the ABCC documentation)
* *filtermanifests.sh* filters the full manifest to just include our targets and reformats the manifest.

These commands output a file, *filtered_manifest.txt*, which includes the s3 paths for all the files we want to download

## Downloading files

*download_subject.sh*, *download_subject.sub*, and *download_subject.py* define an HTcondor batch to download all the data using a custom python script based on examples included in NDA-Tools. It requires a subject list file, which can be generated from the longitudinal tracking table in the tabulated data.

This process requires the generation of a *credfile* using a set of NDA login credentials, which can be done using the script *gencreds.py*. 

# Processing

Two subfolders contain code for additional processing steps designed to run in HTCondor. Each has its own documentation.

## process_split

The folder process_split divides the sample in to chunks (or splits) of 60 participants and outputs information about participant motion, frames available for analysis, and available data to a set of RDS files. 

## qcfc-matrixcalc

Contains code to calculate information needed for the QC-FC plots presented in the paper.

# Concatenation/Packaging

*ABCC_import.Rmd* processes outputs from process_split and packages them into RDS files for use in the main analysis.


# Tools

*abccbuildmanifest.sh and .sub contain code to print manifest files from the downloaded files generated by the above if you want to check the manifests against one another to make sure everything has been fetched.

If you would like to compare the subjects present in the manifest against what is present in the file list, you can use these commands:

```
cat *manifest.txt* > allmanifest.txt
grep -oE 'NDARINV[0-9A-Z]{8}' allmanifest.txt | sort | uniq | tee subjectsinmanifest
grep -oE 'NDARINV[0-9A-Z]{8}' filtered_full_missingness_filelist.txt | sort | uniq | tee subjectsintargets
comm -23 subjectsintargetswdummy subjectsinmanifest > remedialsubjects
grep -f remedialsubjects > remedial_filelist.txt
```

You can then provide the 'remedial' subjects list to the above download commands to download the missing files. Note this will not detect partially downloaded participants.
